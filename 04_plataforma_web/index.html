<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Data Analytics</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-custom { box-shadow: 0 4px 6px rgba(0,0,0,0.08); border: none; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 999; display: flex; justify-content: center; align-items: center; }
        canvas#chartUF { height: 300px; }
    </style>
</head>
<body class="bg-light">
<div id="app" class="container py-5">
    <div v-if="loading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <h1 class="mb-4 text-primary fw-bold">üè• Painel ANS - Health Analytics</h1>

    <div class="row mb-5">
        <div class="col-md-4">
            <div class="card card-custom p-4 text-center bg-white h-100 d-flex flex-column justify-content-center">
                <h5 class="text-muted">Despesas Totais Analisadas</h5>
                <h2 class="text-success fw-bold">R$ {{ formatMoney(estatisticas.total_despesas) }}</h2>
                <small class="text-muted">Dados consolidados do √∫ltimo per√≠odo</small>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card card-custom p-3 h-100 bg-white">
                <canvas id="chartUF"></canvas>
            </div>
        </div>
    </div>

    <div class="card card-custom p-4 bg-white">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Lista de Operadoras</h4>
            <div class="input-group w-50">
                <input type="text" class="form-control" placeholder="Buscar por Raz√£o Social ou CNPJ..." v-model="searchQuery" @input="debouncedFetch">
                <button class="btn btn-primary" @click="fetchOperadoras(1)">Buscar</button>
            </div>
        </div>

        <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>Registro ANS</th>
                <th>CNPJ</th>
                <th>Raz√£o Social</th>
                <th>UF</th>
                <th>A√ß√µes</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="op in operadoras" :key="op.registro_ans">
                <td><strong>{{ op.registro_ans }}</strong></td>
                <td>{{ op.cnpj }}</td>
                <td>{{ op.razao_social }}</td>
                <td><span class="badge bg-secondary">{{ op.uf }}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-info" @click="openModal(op)">Ver Despesas</button>
                </td>
            </tr>
            </tbody>
        </table>

        <nav v-if="meta.pages > 1" class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item" :class="{disabled: meta.page === 1}">
                    <button class="page-link" @click="fetchOperadoras(Math.max(1, meta.page - 1))">Anterior</button>
                </li>
                <li class="page-item disabled"><span class="page-link">P√°gina {{ meta.page }} de {{ meta.pages }}</span></li>
                <li class="page-item" :class="{disabled: meta.page === meta.pages}">
                    <button class="page-link" @click="fetchOperadoras(Math.min(meta.pages, meta.page + 1))">Pr√≥ximo</button>
                </li>
            </ul>
        </nav>
    </div>

    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" v-if="selectedOp">
                        {{ selectedOp.razao_social }}
                        <small class="text-muted d-block fs-6">ANS: {{ selectedOp.registro_ans }}</small>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Hist√≥rico Financeiro</h6>
                    <table class="table table-sm table-striped">
                        <thead><tr><th>Data</th><th>Conta Cont√°bil</th><th class="text-end">Valor</th></tr></thead>
                        <tbody>
                        <tr v-for="desp in despesasOp" :key="desp.id">
                            <td>{{ formatDate(desp.data_referencia) }}</td>
                            <td>{{ desp.descricao_conta }}</td>
                            <td class="text-end fw-bold">R$ {{ formatMoney(desp.valor) }}</td>
                        </tr>
                        <tr v-if="despesasOp.length === 0"><td colspan="3" class="text-center py-3">Nenhum registro encontrado.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            const operadoras = ref([]);
            const estatisticas = ref({ total_despesas: 0, distribuicao_uf: [] });
            const meta = ref({ page: 1, pages: 1 });
            const searchQuery = ref("");
            const loading = ref(false);
            const selectedOp = ref(null);
            const despesasOp = ref([]);
            let chartInstance = null;
            let searchTimer = null;

            const API_URL = "http://127.0.0.1:8000/api";

            const formatMoney = (value) => {
                if (value === undefined || value === null) return "0,00";
                const num = Number(value) || 0;
                return num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };

            const formatDate = (dateString) => {
                if (!dateString) return "-";
                const d = new Date(dateString);
                if (Number.isNaN(d.getTime())) return dateString;
                return d.toLocaleDateString('pt-BR');
            };

            const safeFetch = async (url, options = {}) => {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res;
            };

            const fetchEstatisticas = async () => {
                try {
                    const res = await safeFetch(`${API_URL}/estatisticas`);
                    const data = await res.json();
                    estatisticas.value = data;
                    renderChart(data.distribuicao_uf || data.distribuicao_uf /* backward compat */ || data.distribuicao_uf);
                } catch (e) {
                    console.error("Erro estatisticas", e);
                }
            };

            const fetchOperadoras = async (page = 1) => {
                loading.value = true;
                try {
                    let url = `${API_URL}/operadoras?page=${page}&limit=10`;
                    if (searchQuery.value) url += `&search=${encodeURIComponent(searchQuery.value)}`;

                    const res = await safeFetch(url);
                    const json = await res.json();
                    operadoras.value = json.data || [];
                    meta.value = json.meta || { page: 1, pages: 1 };
                } catch (e) {
                    alert("Erro ao conectar na API. Verifique o servidor.");
                    console.error(e);
                } finally {
                    loading.value = false;
                }
            };

            const debouncedFetch = () => {
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => fetchOperadoras(1), 450);
            };

            const openModal = async (op) => {
                selectedOp.value = op;
                despesasOp.value = [];
                try {
                    const res = await safeFetch(`${API_URL}/operadoras/${op.registro_ans}/despesas`);
                    despesasOp.value = await res.json();
                } catch (e) {
                    console.error("Erro ao buscar despesas", e);
                    despesasOp.value = [];
                }
                const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                modal.show();
            };

            const renderChart = (data) => {
                data = data || [];
                const ctx = document.getElementById('chartUF');
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(item => item.uf),
                        datasets: [{
                            label: 'Despesas por UF (Top)',
                            data: data.map(item => item.total),
                            backgroundColor: '#0d6efd',
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            };

            onMounted(() => {
                fetchEstatisticas();
                fetchOperadoras();
            });

            return {
                operadoras, estatisticas, meta, searchQuery, loading,
                selectedOp, despesasOp, formatMoney, formatDate,
                fetchOperadoras, openModal, debouncedFetch
            };
        }
    }).mount('#app');
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>